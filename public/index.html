<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üêí MonkeySkript</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<style>
  :root {
    --bg: #0a0a0f; --sidebar: #0f0f1a; --panel: #13131f; --border: #1e1e3a;
    --accent: #00ff9d; --accent2: #ff6b35; --accent3: #7c3aed;
    --text: #e2e8f0; --muted: #4a5568; --tab-active: #1a1a2e; --tab-bg: #0f0f1a;
    --danger: #ef4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
  #titlebar { height: 38px; background: #06060f; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 12px; gap: 12px; flex-shrink: 0; z-index: 100; }
  .logo { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 14px; background: linear-gradient(90deg, var(--accent), #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 2px; display: flex; align-items: center; gap: 6px; }
  .logo-icon { font-size: 18px; filter: drop-shadow(0 0 8px var(--accent)); }
  .menu-bar { display: flex; gap: 2px; margin-left: 8px; }
  .menu-item { padding: 4px 10px; font-size: 12px; color: var(--muted); cursor: pointer; border-radius: 4px; font-family: 'JetBrains Mono', monospace; position: relative; }
  .menu-item:hover { background: var(--border); color: var(--text); }
  .dropdown { display: none; position: absolute; top: 100%; left: 0; background: var(--panel); border: 1px solid var(--border); border-radius: 6px; min-width: 200px; z-index: 500; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
  .menu-item:hover .dropdown { display: block; }
  .dd-item { padding: 8px 14px; font-size: 12px; color: var(--text); cursor: pointer; display: flex; justify-content: space-between; align-items: center; gap: 16px; white-space: nowrap; }
  .dd-item:hover { background: rgba(0,255,157,0.08); color: var(--accent); }
  .dd-key { color: var(--muted); font-size: 11px; }
  .dd-sep { height: 1px; background: var(--border); margin: 4px 0; }
  .collab-bar { margin-left: auto; display: flex; align-items: center; gap: 10px; }
  .room-info { display: flex; align-items: center; gap: 8px; background: var(--panel); border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px; font-size: 11px; }
  .pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(0,255,157,0.4)} 50%{box-shadow:0 0 0 6px rgba(0,255,157,0)} }
  .user-avatars { display: flex; gap: 4px; }
  .avatar { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; border: 2px solid var(--bg); cursor: pointer; transition: transform 0.2s; }
  .avatar:hover { transform: scale(1.2); }
  .share-btn { background: linear-gradient(135deg, var(--accent3), #a855f7); border: none; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; cursor: pointer; font-family: 'JetBrains Mono', monospace; transition: all 0.2s; }
  .share-btn:hover { transform: scale(1.05); box-shadow: 0 0 12px rgba(124,58,237,0.5); }
  #app { display: flex; flex: 1; overflow: hidden; }
  #activitybar { width: 48px; background: #06060f; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 8px 0; gap: 4px; flex-shrink: 0; }
  .activity-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; border-radius: 6px; color: var(--muted); transition: all 0.2s; position: relative; }
  .activity-icon:hover { color: var(--text); background: var(--border); }
  .activity-icon.active { color: var(--accent); }
  .activity-icon.active::before { content: ''; position: absolute; left: -8px; top: 50%; transform: translateY(-50%); width: 2px; height: 20px; background: var(--accent); border-radius: 0 2px 2px 0; }
  #sidebar { width: 240px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; }
  .sidebar-header { padding: 10px 14px; font-size: 10px; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .sidebar-action { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 14px; padding: 2px 4px; border-radius: 3px; transition: all 0.15s; }
  .sidebar-action:hover { color: var(--accent); background: var(--border); }
  #file-tree { flex: 1; overflow-y: auto; padding: 4px 0; }
  #file-tree::-webkit-scrollbar { width: 4px; }
  #file-tree::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .folder-row { display: flex; align-items: center; gap: 6px; padding: 5px 10px; font-size: 12px; cursor: pointer; color: #a0aec0; border-radius: 4px; margin: 1px 6px; font-weight: 600; user-select: none; }
  .folder-row:hover { background: var(--border); color: var(--text); }
  .folder-row .fa { margin-left: auto; display: none; gap: 2px; }
  .folder-row:hover .fa { display: flex; }
  .file-item { display: flex; align-items: center; gap: 8px; padding: 5px 14px; font-size: 13px; cursor: pointer; transition: background 0.1s; border-radius: 4px; margin: 1px 6px; color: var(--text); }
  .file-item.indented { padding-left: 28px; }
  .file-item:hover { background: var(--border); }
  .file-item.active { background: rgba(0,255,157,0.08); color: var(--accent); }
  .file-item .factions { margin-left: auto; display: none; gap: 2px; }
  .file-item:hover .factions { display: flex; }
  .fact-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 11px; padding: 2px 3px; border-radius: 2px; line-height: 1; }
  .fact-btn:hover { color: white; background: var(--danger); }
  .fact-btn.safe:hover { color: var(--accent); background: transparent; }
  #editor-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  #tabs { height: 35px; background: var(--tab-bg); border-bottom: 1px solid var(--border); display: flex; overflow-x: auto; flex-shrink: 0; }
  #tabs::-webkit-scrollbar { height: 3px; }
  #tabs::-webkit-scrollbar-thumb { background: var(--accent3); }
  .tab { display: flex; align-items: center; gap: 8px; padding: 0 14px; height: 100%; cursor: pointer; border-right: 1px solid var(--border); white-space: nowrap; font-size: 12px; color: var(--muted); transition: all 0.15s; flex-shrink: 0; }
  .tab:hover { background: var(--border); color: var(--text); }
  .tab.active { background: var(--tab-active); color: var(--text); border-bottom: 2px solid var(--accent); }
  .tab-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 14px; width: 18px; height: 18px; border-radius: 3px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; flex-shrink: 0; }
  .tab-close:hover { background: var(--danger); color: white; }
  #editor-container { flex: 1; position: relative; overflow: hidden; }
  #monaco-editor { width: 100%; height: 100%; }
  .empty-state { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; color: var(--muted); }
  .empty-logo { font-size: 64px; filter: drop-shadow(0 0 20px var(--accent)); animation: float 3s ease-in-out infinite; }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
  .empty-title { font-family: 'Orbitron', sans-serif; font-size: 28px; font-weight: 900; background: linear-gradient(90deg, var(--accent), #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 4px; }
  .empty-sub { font-size: 13px; color: var(--muted); }
  .start-actions { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; justify-content: center; }
  .start-btn { padding: 10px 20px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 12px; cursor: pointer; transition: all 0.2s; border: none; }
  .start-btn.primary { background: linear-gradient(135deg, var(--accent), #00d4ff); color: #000; font-weight: 700; }
  .start-btn.primary:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,255,157,0.4); }
  .start-btn.secondary { background: var(--panel); color: var(--text); border: 1px solid var(--border); }
  .start-btn.secondary:hover { border-color: var(--accent3); color: var(--accent3); }
  #statusbar { height: 24px; background: var(--accent3); display: flex; align-items: center; padding: 0 12px; gap: 16px; font-size: 11px; flex-shrink: 0; color: rgba(255,255,255,0.9); }
  .status-item { display: flex; align-items: center; gap: 4px; cursor: pointer; }
  .status-item:hover { opacity: 0.8; }
  .status-sep { opacity: 0.3; }
  .status-right { margin-left: auto; display: flex; gap: 16px; }
  #bottom-panel { height: 150px; background: var(--panel); border-top: 1px solid var(--border); flex-shrink: 0; display: flex; flex-direction: column; }
  #bottom-panel.hidden { height: 0; overflow: hidden; }
  .panel-tabs { display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .panel-tab { padding: 6px 14px; font-size: 11px; cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent; transition: all 0.15s; }
  .panel-tab.active { color: var(--accent); border-color: var(--accent); }
  #terminal { flex: 1; padding: 8px 12px; overflow-y: auto; font-size: 12px; color: #8be9fd; }
  #terminal::-webkit-scrollbar { width: 4px; }
  #terminal::-webkit-scrollbar-thumb { background: var(--border); }
  .terminal-line { line-height: 1.6; }
  .terminal-line.error { color: #ff5555; }
  .terminal-line.success { color: var(--accent); }
  .terminal-line.warn { color: #ffb86c; }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; width: 480px; max-width: 90vw; padding: 24px; box-shadow: 0 0 60px rgba(0,0,255,0.1); animation: modalIn 0.2s ease; max-height: 90vh; overflow-y: auto; }
  @keyframes modalIn { from{transform:scale(0.9);opacity:0} to{transform:scale(1);opacity:1} }
  .modal h2 { font-family: 'Orbitron', sans-serif; font-size: 16px; background: linear-gradient(90deg, var(--accent), #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 16px; letter-spacing: 2px; }
  .modal h3 { font-size: 11px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin: 20px 0 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
  .modal-input { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px 14px; border-radius: 8px; font-size: 14px; font-family: 'JetBrains Mono', monospace; outline: none; transition: border 0.2s; margin-bottom: 12px; }
  .modal-input:focus { border-color: var(--accent); }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; }
  .btn { padding: 8px 18px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 13px; cursor: pointer; border: none; transition: all 0.2s; }
  .btn-primary { background: var(--accent); color: #000; font-weight: 700; }
  .btn-primary:hover { box-shadow: 0 0 16px rgba(0,255,157,0.5); }
  .btn-secondary { background: var(--bg); color: var(--muted); border: 1px solid var(--border); }
  .btn-secondary:hover { color: var(--text); }
  .btn-danger { background: var(--danger); color: white; }
  .room-code { background: var(--bg); border: 1px solid var(--accent); border-radius: 8px; padding: 12px; font-size: 20px; letter-spacing: 4px; text-align: center; color: var(--accent); font-weight: 700; cursor: pointer; margin-bottom: 12px; }
  .room-code:hover { background: rgba(0,255,157,0.05); }
  .collab-users { margin-top: 12px; }
  .collab-user-row { display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg); border-radius: 8px; margin-bottom: 6px; font-size: 12px; }
  #notifications { position: fixed; top: 50px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
  .notif { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px 16px; font-size: 12px; max-width: 320px; animation: slideIn 0.3s ease; border-left: 3px solid var(--accent); }
  .notif.error { border-color: var(--danger); }
  .notif.warn { border-color: var(--accent2); }
  .notif.success { border-color: var(--accent); }
  @keyframes slideIn { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }
  #command-palette { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); width: 560px; background: var(--panel); border: 1px solid var(--border); border-radius: 10px; z-index: 2000; display: none; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
  #command-palette.open { display: block; }
  #cmd-input { width: 100%; background: var(--bg); border: none; border-bottom: 1px solid var(--border); color: var(--text); padding: 14px 18px; font-size: 14px; font-family: 'JetBrains Mono', monospace; outline: none; }
  .cmd-results { max-height: 300px; overflow-y: auto; }
  .cmd-result { padding: 10px 18px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; transition: background 0.1s; }
  .cmd-result:hover, .cmd-result.selected { background: rgba(0,255,157,0.08); }
  .cmd-key { color: var(--muted); font-size: 11px; }
  #resize-handle { height: 4px; background: var(--border); cursor: ns-resize; flex-shrink: 0; }
  #resize-handle:hover { background: var(--accent3); }
  #search-panel { padding: 10px; display: none; flex-direction: column; gap: 8px; }
  .search-input { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 7px 10px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; outline: none; }
  .search-input:focus { border-color: var(--accent3); }
  .search-result { padding: 5px 8px; cursor: pointer; border-radius: 4px; font-size: 12px; }
  .search-result:hover { background: var(--border); }
  .search-match { color: var(--accent2); font-weight: 700; }
  #snippet-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
  .snippet-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; cursor: pointer; transition: border-color 0.2s; }
  .snippet-card:hover { border-color: var(--accent3); }
  .snippet-title { font-size: 12px; color: var(--accent3); margin-bottom: 6px; }
  .snippet-preview { font-size: 11px; color: var(--muted); white-space: pre-wrap; margin: 0; }
  .conn-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--muted); display: inline-block; margin-right: 4px; }
  .conn-dot.connected { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
  /* Settings */
  .setting-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); gap: 16px; }
  .setting-row:last-child { border-bottom: none; }
  .setting-label { font-size: 13px; flex-shrink: 0; }
  .setting-desc { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .toggle { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--border); border-radius: 20px; transition: 0.2s; }
  .toggle-slider:before { content:''; position: absolute; width: 14px; height: 14px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.2s; }
  input:checked + .toggle-slider { background: var(--accent); }
  input:checked + .toggle-slider:before { transform: translateX(16px); }
  .modal-select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; outline: none; cursor: pointer; flex-shrink: 0; }
</style>
</head>
<body>

<div id="titlebar">
  <div class="logo"><span class="logo-icon">üêí</span>MONKEYSKRIPT</div>
  <div class="menu-bar">
    <div class="menu-item">File
      <div class="dropdown">
        <div class="dd-item" onclick="newFile()">New Script <span class="dd-key">Ctrl+N</span></div>
        <div class="dd-item" onclick="newFolder()">New Folder</div>
        <div class="dd-sep"></div>
        <div class="dd-item" onclick="downloadActiveFile()">Download Current File</div>
        <div class="dd-item" onclick="downloadAllFiles()">Download All as ZIP</div>
        <div class="dd-sep"></div>
        <div class="dd-item" onclick="saveAll()">Save All <span class="dd-key">Ctrl+S</span></div>
      </div>
    </div>
    <div class="menu-item">Edit
      <div class="dropdown">
        <div class="dd-item" onclick="openCommandPalette()">Command Palette <span class="dd-key">Ctrl+Shift+P</span></div>
        <div class="dd-item" onclick="editor&&editor.getAction('editor.action.formatDocument')?.run()">Format Document</div>
        <div class="dd-item" onclick="editor&&editor.getAction('editor.action.commentLine')?.run()">Toggle Comment <span class="dd-key">Ctrl+/</span></div>
      </div>
    </div>
    <div class="menu-item">View
      <div class="dropdown">
        <div class="dd-item" onclick="togglePanel()">Toggle Terminal <span class="dd-key">Ctrl+`</span></div>
        <div class="dd-item" onclick="switchActivity('files')">Explorer</div>
        <div class="dd-item" onclick="switchActivity('search')">Search</div>
      </div>
    </div>
    <div class="menu-item">Run
      <div class="dropdown">
        <div class="dd-item" onclick="validateScript()">Validate Script</div>
        <div class="dd-item" onclick="showSkriptSnippets()">Insert Snippet üß©</div>
      </div>
    </div>
    <div class="menu-item">Help
      <div class="dropdown">
        <div class="dd-item" onclick="openSettings()">Settings ‚öôÔ∏è</div>
        <div class="dd-item" onclick="notify('üêí MonkeySkript ‚Äî Ctrl+Shift+P for all commands')">About</div>
      </div>
    </div>
  </div>
  <div class="collab-bar">
    <div class="room-info" id="room-display" style="display:none">
      <div class="pulse"></div>
      <span id="room-label">Room: --</span>
      <div class="user-avatars" id="avatar-list"></div>
    </div>
    <button class="share-btn" onclick="openShareModal()">‚ö° Live Share</button>
  </div>
</div>

<div id="notifications"></div>
<div id="command-palette">
  <input id="cmd-input" placeholder="Type a command... (Ctrl+Shift+P)" oninput="filterCmds()" onkeydown="cmdKeydown(event)">
  <div class="cmd-results" id="cmd-results"></div>
</div>

<div id="app">
  <div id="activitybar">
    <div class="activity-icon active" id="ab-files" onclick="switchActivity('files')" title="Explorer">üìÅ</div>
    <div class="activity-icon" id="ab-search" onclick="switchActivity('search')" title="Search">üîç</div>
    <div class="activity-icon" onclick="openShareModal()" title="Live Collab">üë•</div>
    <div class="activity-icon" onclick="showSkriptSnippets()" title="Snippets">üß©</div>
    <div style="margin-top:auto"></div>
    <div class="activity-icon" onclick="openSettings()" title="Settings">‚öôÔ∏è</div>
  </div>

  <div id="sidebar">
    <div class="sidebar-header">
      <span id="sidebar-title">EXPLORER</span>
      <div style="display:flex;gap:2px">
        <button class="sidebar-action" onclick="newFile()" title="New File">üìÑ</button>
        <button class="sidebar-action" onclick="newFolder()" title="New Folder">üìÅ</button>
        <button class="sidebar-action" onclick="downloadAllFiles()" title="Download All">‚¨á</button>
      </div>
    </div>
    <div id="file-tree-panel" style="flex:1;overflow-y:auto">
      <div id="file-tree"></div>
    </div>
    <div id="search-panel">
      <input class="search-input" id="search-input" placeholder="Search in files..." oninput="searchFiles()">
      <div id="search-results"></div>
    </div>
  </div>

  <div id="editor-area">
    <div id="tabs"></div>
    <div id="editor-container">
      <div class="empty-state" id="empty-state">
        <div class="empty-logo">üêí</div>
        <div class="empty-title">MONKEYSKRIPT</div>
        <div class="empty-sub">Minecraft Skript IDE ‚Ä¢ Multiplayer ‚Ä¢ VS Code Powered</div>
        <div class="start-actions">
          <button class="start-btn primary" onclick="newFile()">+ New Script</button>
          <button class="start-btn secondary" onclick="openShareModal()">‚ö° Join Room</button>
          <button class="start-btn secondary" onclick="openCommandPalette()">‚åò Commands</button>
          <button class="start-btn secondary" onclick="openSettings()">‚öôÔ∏è Settings</button>
        </div>
      </div>
      <div id="monaco-editor" style="display:none;width:100%;height:100%"></div>
    </div>
    <div id="resize-handle" onmousedown="startResize(event)"></div>
    <div id="bottom-panel" class="hidden">
      <div class="panel-tabs">
        <div class="panel-tab active" onclick="switchPanelTab(this)">TERMINAL</div>
        <div class="panel-tab" onclick="switchPanelTab(this)">OUTPUT</div>
      </div>
      <div id="terminal"><div class="terminal-line success">üêí MonkeySkript ready</div></div>
    </div>
  </div>
</div>

<div id="statusbar">
  <div class="status-item" onclick="togglePanel()"><span class="conn-dot" id="conn-dot"></span><span id="conn-status">Offline</span></div>
  <span class="status-sep">|</span>
  <div class="status-item" onclick="openShareModal()"><span id="sb-collab">üë§ Solo</span></div>
  <div class="status-right">
    <div class="status-item"><span id="sb-pos">Ln 1, Col 1</span></div>
    <span class="status-sep">|</span>
    <div class="status-item">Skript</div>
    <span class="status-sep">|</span>
    <div class="status-item">UTF-8</div>
  </div>
</div>

<div class="modal-overlay" id="share-modal" onclick="if(event.target===this)closeModal('share-modal')">
  <div class="modal">
    <h2>‚ö° LIVE SHARE</h2>
    <div id="share-create">
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Create a room and share the code with friends.</p>
      <input class="modal-input" id="room-name-input" placeholder="Your display name (e.g. MonkeyDev)">
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('share-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="createRoom()">üöÄ Create Room</button>
      </div>
      <hr style="border-color:var(--border);margin:16px 0">
      <button class="btn btn-secondary" style="width:100%" onclick="showJoinRoom()">üîó Join Existing Room ‚Üí</button>
    </div>
    <div id="share-join" style="display:none">
      <input class="modal-input" id="join-name-input" placeholder="Your display name">
      <input class="modal-input" id="join-code-input" placeholder="Room code (MONK-XXXX)" style="text-transform:uppercase;letter-spacing:2px">
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="showCreateRoom()">‚Üê Back</button>
        <button class="btn btn-primary" onclick="joinRoom()">‚ö° Join Room</button>
      </div>
    </div>
    <div id="share-active" style="display:none">
      <p style="font-size:12px;color:var(--muted);margin-bottom:8px">Share this code with friends:</p>
      <div class="room-code" id="active-room-code" onclick="copyRoomCode()">----</div>
      <p style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:12px">Click code to copy ‚Ä¢ Scripts auto-save</p>
      <div class="collab-users" id="active-collab-users"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="leaveRoom()">üö™ Leave</button>
        <button class="btn btn-primary" onclick="copyRoomCode()">üìã Copy Code</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="newfile-modal" onclick="if(event.target===this)closeModal('newfile-modal')">
  <div class="modal">
    <h2>üìú NEW SCRIPT</h2>
    <input class="modal-input" id="newfile-name" placeholder="filename.sk" onkeydown="if(event.key==='Enter')createNewFile()">
    <select class="modal-input" id="newfile-folder" style="cursor:pointer">
      <option value="">üìÇ Root (no folder)</option>
    </select>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('newfile-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="createNewFile()">Create</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="newfolder-modal" onclick="if(event.target===this)closeModal('newfolder-modal')">
  <div class="modal">
    <h2>üìÅ NEW FOLDER</h2>
    <input class="modal-input" id="newfolder-name" placeholder="folder-name" onkeydown="if(event.key==='Enter')createNewFolder()">
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('newfolder-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="createNewFolder()">Create Folder</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="snippets-modal" onclick="if(event.target===this)closeModal('snippets-modal')">
  <div class="modal" style="width:600px;max-width:95vw">
    <h2>üß© SKRIPT SNIPPETS</h2>
    <div id="snippet-list"></div>
    <div class="modal-actions" style="margin-top:16px">
      <button class="btn btn-secondary" onclick="closeModal('snippets-modal')">Close</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="settings-modal" onclick="if(event.target===this)closeModal('settings-modal')">
  <div class="modal" style="width:500px">
    <h2>‚öôÔ∏è SETTINGS</h2>
    <h3>Editor</h3>
    <div class="setting-row">
      <div><div class="setting-label">Font Size</div><div class="setting-desc">Editor font size</div></div>
      <select class="modal-select" id="s-fontsize" onchange="applyEditorOption('fontSize',+this.value)">
        <option value="12">12px</option><option value="13">13px</option><option value="14" selected>14px</option><option value="15">15px</option><option value="16">16px</option><option value="18">18px</option><option value="20">20px</option>
      </select>
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Tab Size</div><div class="setting-desc">Spaces per indent</div></div>
      <select class="modal-select" id="s-tabsize" onchange="applyEditorOption('tabSize',+this.value)">
        <option value="2">2 spaces</option><option value="4" selected>4 spaces</option><option value="8">8 spaces</option>
      </select>
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Word Wrap</div><div class="setting-desc">Wrap long lines</div></div>
      <label class="toggle"><input type="checkbox" id="s-wrap" onchange="applyEditorOption('wordWrap',this.checked?'on':'off')"><span class="toggle-slider"></span></label>
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Minimap</div><div class="setting-desc">Code overview on the right</div></div>
      <label class="toggle"><input type="checkbox" id="s-minimap" checked onchange="applyEditorOption('minimap',{enabled:this.checked})"><span class="toggle-slider"></span></label>
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Line Numbers</div><div class="setting-desc">Show line numbers</div></div>
      <label class="toggle"><input type="checkbox" id="s-linenums" checked onchange="applyEditorOption('lineNumbers',this.checked?'on':'off')"><span class="toggle-slider"></span></label>
    </div>
    <h3>Multiplayer</h3>
    <div class="setting-row">
      <div><div class="setting-label">Display Name</div><div class="setting-desc">Your name in rooms</div></div>
      <input class="modal-select" id="s-name" style="width:130px;text-align:right" placeholder="MonkeyDev" oninput="myName=this.value||myName">
    </div>
    <h3>Data</h3>
    <div class="setting-row">
      <div><div class="setting-label">Clear All Files</div><div class="setting-desc">Remove everything locally</div></div>
      <button class="btn btn-danger" onclick="clearAllFiles()">Clear</button>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="closeModal('settings-modal')">Done</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let editor = null;
let files = {};          // path -> content
let folders = new Set(); // folder names
let collapsed = new Set();
let activeFile = null;
let openTabs = [];
let panelVisible = false;
let currentActivity = 'files';
let roomId = null;
let myName = 'Monkey' + Math.floor(Math.random()*99);
const COLORS = ['#7c3aed','#2563eb','#059669','#d97706','#dc2626','#db2777','#0891b2','#65a30d'];
let myColor = COLORS[Math.floor(Math.random()*COLORS.length)];
let lastTypedAt = 0;   // guards editor from being overwritten mid-keystroke
let sseSource = null;  // the EventSource connection
let presenceInterval = null;

// ============================================================
// SSE ‚Äî Real-time push from server
// ============================================================
function applyRemoteFile(filename, content) {
  // Update local file store
  files[filename] = content;
  // If this file is open in the editor, update it ‚Äî but not if user just typed
  if (filename === activeFile && editor) {
    if (editor.getValue() === content) return; // already identical
    if (Date.now() - lastTypedAt < 2000) return; // user is mid-typing, skip
    const model = editor.getModel();
    editor.executeEdits('remote-sync', [{ range: model.getFullModelRange(), text: content, forceMoveMarkers: false }]);
  }
}

function connectSSE() {
  if (sseSource) sseSource.close();

  const url = `/api/rooms/${roomId}/stream?userName=${encodeURIComponent(myName)}`;
  sseSource = new EventSource(url);

  sseSource.addEventListener('init', e => {
    // Server sends full file list on connect
    const { files: roomFiles } = JSON.parse(e.data);
    let treeNeedsUpdate = false;
    for (const [filename, content] of Object.entries(roomFiles)) {
      if (files[filename] !== content) {
        files[filename] = content;
        treeNeedsUpdate = true;
        if (filename.includes('/')) folders.add(filename.split('/')[0]);
      }
    }
    if (treeNeedsUpdate) renderFileTree();
    setConnected(true);
  });

  sseSource.addEventListener('file:update', e => {
    const { filename, content } = JSON.parse(e.data);
    if (files[filename] === content) return;
    applyRemoteFile(filename, content);
    renderFileTree();
    setConnected(true);
  });

  sseSource.addEventListener('file:delete', e => {
    const { filename } = JSON.parse(e.data);
    delete files[filename];
    if (activeFile === filename) { activeFile = null; openTabs = openTabs.filter(t => t !== filename); renderTabs(); }
    renderFileTree();
  });

  sseSource.addEventListener('file:rename', e => {
    const { oldName, newName } = JSON.parse(e.data);
    files[newName] = files[oldName]; delete files[oldName];
    if (activeFile === oldName) activeFile = newName;
    openTabs = openTabs.map(t => t === oldName ? newName : t);
    renderFileTree(); renderTabs();
  });

  sseSource.addEventListener('presence', e => {
    const { users } = JSON.parse(e.data);
    updateCollabDisplay(users);
  });

  sseSource.onerror = () => {
    setConnected(false);
    // Auto-reconnect after 3s if still in a room
    setTimeout(() => { if (roomId) connectSSE(); }, 3000);
  };

  sseSource.onopen = () => setConnected(true);
}

function setConnected(yes) {
  document.getElementById('conn-dot').classList.toggle('connected', yes);
  document.getElementById('conn-status').textContent = yes ? 'Connected' : 'Reconnecting...';
}

async function sendPresence() {
  if (!roomId) return;
  try {
    await fetch(`/api/rooms/${roomId}/presence`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ userName: myName, userColor: myColor, editingFile: activeFile||'' })
    });
  } catch(e) {}
}

async function saveFileToServer(filename, content) {
  if (!roomId) return;
  try {
    await fetch(`/api/rooms/${roomId}/files`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ filename, content, userName: myName })
    });
  } catch(e) {}
}

// Keep presence heartbeat so avatar list stays fresh
function startPresenceHeartbeat() {
  if (presenceInterval) clearInterval(presenceInterval);
  presenceInterval = setInterval(sendPresence, 8000);
  sendPresence();
}

// ============================================================
// ROOMS
// ============================================================
async function createRoom() {
  myName = document.getElementById('room-name-input').value.trim() || myName;
  try {
    const res = await fetch('/api/rooms', { method: 'POST' });
    const { roomId: id } = await res.json();
    roomId = id;
    // Upload any existing local files to the new room
    for (const [name, content] of Object.entries(files)) await saveFileToServer(name, content);
    connectSSE();
    startPresenceHeartbeat();
    showActiveRoom(); closeModal('share-modal');
    notify(`üöÄ Room ${roomId} created!`, 'success');
    termLog(`> Room ${roomId} created ‚Äî share the code!`, 'success');
  } catch(e) { notify('Could not create room', 'error'); }
}

async function joinRoom() {
  myName = document.getElementById('join-name-input').value.trim() || myName;
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  if (!code) { notify('Enter a room code!', 'error'); return; }
  try {
    const check = await fetch(`/api/rooms/${code}`);
    if (!check.ok) { notify('Room not found!', 'error'); return; }
    roomId = code;
    // SSE init event will deliver all files automatically
    connectSSE();
    startPresenceHeartbeat();
    showActiveRoom(); closeModal('share-modal');
    notify(`‚ö° Joined room ${roomId}!`, 'success');
    termLog(`> Joined ${roomId} as ${myName}`, 'success');
  } catch(e) { notify('Could not join room', 'error'); }
}

async function leaveRoom() {
  if (sseSource) { sseSource.close(); sseSource = null; }
  if (presenceInterval) { clearInterval(presenceInterval); presenceInterval = null; }
  if (roomId) fetch(`/api/rooms/${roomId}/presence/${encodeURIComponent(myName)}`, {method:'DELETE'}).catch(()=>{});
  roomId = null;
  document.getElementById('room-display').style.display = 'none';
  document.getElementById('sb-collab').textContent = 'üë§ Solo';
  document.getElementById('conn-dot').classList.remove('connected');
  document.getElementById('conn-status').textContent = 'Offline';
  showCreateRoom(); notify('üö™ Left the room');
}

function updateCollabDisplay(users) {
  const others = users.filter(u => u.user_name !== myName);
  document.getElementById('sb-collab').textContent = others.length > 0 ? `üë• ${others.length+1} online` : 'üë§ Solo';
  const al = document.getElementById('avatar-list'); al.innerHTML = '';
  const myAv = Object.assign(document.createElement('div'), {className:'avatar', textContent: myName[0].toUpperCase(), title: myName+' (you)'});
  myAv.style.background = myColor; al.appendChild(myAv);
  others.forEach(u => {
    const av = Object.assign(document.createElement('div'), {className:'avatar', textContent:(u.user_name||'?')[0].toUpperCase(), title: u.user_name+(u.editing_file?` ‚Äî ${u.editing_file}`:'')});
    av.style.background = u.user_color||'#7c3aed'; al.appendChild(av);
  });
  document.getElementById('room-display').style.display = 'flex';
  document.getElementById('room-label').textContent = `Room: ${roomId}`;
  const ul = document.getElementById('active-collab-users');
  if (!ul) return;
  ul.innerHTML = '<p style="font-size:11px;color:var(--muted);margin-bottom:8px">Connected:</p>';
  [{user_name:myName,user_color:myColor,isMe:true},...others].forEach(u => {
    const d = document.createElement('div'); d.className = 'collab-user-row';
    d.innerHTML = `<div class="avatar" style="background:${u.user_color}">${(u.user_name||'?')[0].toUpperCase()}</div><span>${u.user_name}${u.isMe?' (you)':''}</span>${u.editing_file?`<span style="margin-left:auto;color:var(--muted);font-size:11px">üìù ${u.editing_file}</span>`:''}`;
    ul.appendChild(d);
  });
}

function showActiveRoom() {
  ['share-create','share-join'].forEach(id => document.getElementById(id).style.display='none');
  document.getElementById('share-active').style.display = 'block';
  document.getElementById('active-room-code').textContent = roomId;
}
function showCreateRoom() {
  document.getElementById('share-create').style.display = 'block';
  document.getElementById('share-join').style.display = 'none';
  document.getElementById('share-active').style.display = 'none';
}
function showJoinRoom() {
  document.getElementById('share-create').style.display = 'none';
  document.getElementById('share-join').style.display = 'block';
}
function copyRoomCode() { navigator.clipboard.writeText(roomId).then(()=>notify('üìã Copied!','success')); }

// ============================================================
// MONACO
// ============================================================
require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], function() {
  monaco.languages.register({id:'skript'});
  monaco.languages.setMonarchTokensProvider('skript', { tokenizer: { root: [
    [/#.*$/, 'comment'], [/"[^"]*"/, 'string'], [/'[^']*'/, 'string'],
    [/\b(on|command|function|if|else|loop|while|trigger|send|broadcast|give|set|add|remove|return|stop|cancel|event|every|seconds|minutes|hours|aliases|permission)\b/, 'keyword'],
    [/\b(player|block|item|entity|world|location|number|text|boolean)\b/, 'type'],
    [/\b(is|are|not|and|or|greater|less|than|equal|to|from|in|at|of)\b/, 'operator'],
    [/\{[^}]*\}/, 'variable'], [/%[^%]*%/, 'variable'], [/\b\d+(\.\d+)?\b/, 'number'],
  ]}});
  monaco.languages.setLanguageConfiguration('skript', {
    autoClosingPairs: [{open:'{',close:'}'},{open:'[',close:']'},{open:'(',close:')'},{open:'"',close:'"'},{open:"'",close:"'"},{open:'%',close:'%'}],
    comments: {lineComment:'#'}, indentationRules: {increaseIndentPattern:/:\s*$/, decreaseIndentPattern:/^\s*(else|end)/}
  });
  monaco.editor.defineTheme('monkeyskript', { base:'vs-dark', inherit:true,
    rules: [
      {token:'comment',foreground:'4a5568',fontStyle:'italic'},{token:'keyword',foreground:'ff6b35',fontStyle:'bold'},
      {token:'type',foreground:'00d4ff'},{token:'operator',foreground:'c678dd'},{token:'string',foreground:'98c379'},
      {token:'variable',foreground:'e5c07b'},{token:'number',foreground:'d19a66'},
    ],
    colors: {'editor.background':'#0a0a0f','editor.foreground':'#e2e8f0','editorCursor.foreground':'#00ff9d',
      'editor.selectionBackground':'#1e1e3a','editor.lineHighlightBackground':'#0f0f1a',
      'editorLineNumber.foreground':'#2d2d4a','editorLineNumber.activeForeground':'#00ff9d'}
  });
  monaco.languages.registerCompletionItemProvider('skript', { provideCompletionItems: (model, position) => {
    const word = model.getWordUntilPosition(position);
    const range = {startLineNumber:position.lineNumber,endLineNumber:position.lineNumber,startColumn:word.startColumn,endColumn:word.endColumn};
    return { suggestions: [
      {label:'on join',kind:27,insertText:'on join:\n\t${1:send "Welcome %player%!" to player}',insertTextRules:4,range},
      {label:'on death',kind:27,insertText:'on death of player:\n\t${1:broadcast "%player% died!"}',insertTextRules:4,range},
      {label:'command',kind:27,insertText:'command /${1:name}:\n\ttrigger:\n\t\t${2:send "Hi!" to player}',insertTextRules:4,range},
      {label:'on chat',kind:27,insertText:'on chat:\n\t${1:cancel event}',insertTextRules:4,range},
      {label:'loop all players',kind:27,insertText:'loop all players:\n\t${1:send "Hi!" to loop-player}',insertTextRules:4,range},
      {label:'if',kind:27,insertText:'if ${1:condition}:\n\t${2:}',insertTextRules:4,range},
      {label:'if/else',kind:27,insertText:'if ${1:condition}:\n\t${2:}\nelse:\n\t${3:}',insertTextRules:4,range},
      {label:'function',kind:27,insertText:'function ${1:name}(${2:p: player}):\n\t${3:}',insertTextRules:4,range},
      {label:'every x seconds',kind:27,insertText:'every ${1:5} seconds:\n\t${2:}',insertTextRules:4,range},
      {label:'send',kind:14,insertText:'send "${1:message}" to player',insertTextRules:4,range},
      {label:'broadcast',kind:14,insertText:'broadcast "${1:message}"',insertTextRules:4,range},
      {label:'give player',kind:14,insertText:'give player ${1:1} ${2:diamond}',insertTextRules:4,range},
      {label:'set variable',kind:27,insertText:'set {${1:var.%player%}} to ${2:0}',insertTextRules:4,range},
      {label:'on break',kind:27,insertText:'on break of ${1:grass}:\n\t${2:cancel event}',insertTextRules:4,range},
      {label:'on damage',kind:27,insertText:'on damage:\n\tif attacker is a player:\n\t\t${1:}',insertTextRules:4,range},
    ]};
  }});

  editor = monaco.editor.create(document.getElementById('monaco-editor'), {
    language:'skript', theme:'monkeyskript', fontSize:14, fontFamily:"'JetBrains Mono',monospace",
    fontLigatures:true, minimap:{enabled:true}, scrollBeyondLastLine:false, automaticLayout:true,
    bracketPairColorization:{enabled:true}, suggest:{preview:true}, lineNumbers:'on', wordWrap:'off',
    cursorStyle:'line', cursorBlinking:'smooth', smoothScrolling:true, mouseWheelZoom:true,
    padding:{top:8}, tabSize:4, insertSpaces:true,
  });

  editor.onDidChangeCursorPosition(e => {
    document.getElementById('sb-pos').textContent = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
  });

  let saveTimer = null;
  editor.onDidChangeModelContent((e) => {
    if (!activeFile) return;
    // Only mark as "user typed" for real keystrokes, not our remote-sync edits
    const isRemote = e.changes.length > 0 && e.changes[0].text.length > 50; // heuristic; remote edits tend to be large replacements
    if (!isRemote) lastTypedAt = Date.now();
    files[activeFile] = editor.getValue();
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => saveFileToServer(activeFile, files[activeFile]), 300);
  });

  notify('üêí MonkeySkript loaded!', 'success');
  
  // If a file was clicked while the editor was still downloading, load it now!
  if (activeFile) {
      editor.setValue(files[activeFile] || '');
      requestAnimationFrame(() => editor.layout());
  }
});

// ============================================================
// SETTINGS
// ============================================================
function applyEditorOption(key, val) {
  if (editor) editor.updateOptions({[key]: val});
  try { localStorage.setItem('ms_'+key, JSON.stringify(val)); } catch(e) {}
}
function loadSettings() {
  ['fontSize','wordWrap','minimap','lineNumbers','tabSize'].forEach(k => {
    try { const v = localStorage.getItem('ms_'+k); if (v && editor) editor.updateOptions({[k]:JSON.parse(v)}); } catch(e) {}
  });
}
function openSettings() {
  document.getElementById('s-name').value = myName;
  document.getElementById('settings-modal').classList.add('open');
}
function clearAllFiles() {
  if (!confirm('Delete ALL local files? Cannot be undone.')) return;
  files = {}; folders = new Set(); activeFile = null; openTabs = [];
  renderFileTree(); renderTabs();
  document.getElementById('empty-state').style.display = 'flex';
  document.getElementById('monaco-editor').style.display = 'none';
  notify('üóë Files cleared', 'warn');
}

// ============================================================
// DOWNLOAD
// ============================================================
function downloadActiveFile() {
  if (!activeFile) { notify('No file open!', 'warn'); return; }
  const blob = new Blob([files[activeFile]||''], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = activeFile.split('/').pop();
  a.click(); URL.revokeObjectURL(a.href);
  notify(`‚¨á Downloaded ${activeFile.split('/').pop()}`, 'success');
}

async function downloadAllFiles() {
  const list = Object.keys(files);
  if (!list.length) { notify('No files!', 'warn'); return; }
  if (list.length === 1) { downloadSingleFile(list[0]); return; }
  if (typeof JSZip === 'undefined') {
    await new Promise(res => { const s = document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js'; s.onload=res; document.head.appendChild(s); });
  }
  const zip = new JSZip();
  list.forEach(name => zip.file(name, files[name]||''));
  const blob = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (roomId ? `room-${roomId}` : 'monkeyskript') + '.zip';
  a.click(); URL.revokeObjectURL(a.href);
  notify(`‚¨á Downloaded ${list.length} files as ZIP`, 'success');
}

function downloadSingleFile(name) {
  const blob = new Blob([files[name]||''], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name.split('/').pop();
  a.click(); URL.revokeObjectURL(a.href);
  notify(`‚¨á Downloaded ${name.split('/').pop()}`, 'success');
}

function saveAll() {
  Object.entries(files).forEach(([n,c]) => saveFileToServer(n,c));
  notify('üíæ Saved all files', 'success');
}

// ============================================================
// FOLDERS
// ============================================================
function newFolder() {
  document.getElementById('newfolder-name').value = '';
  document.getElementById('newfolder-modal').classList.add('open');
  setTimeout(() => document.getElementById('newfolder-name').focus(), 100);
}
function createNewFolder() {
  const name = document.getElementById('newfolder-name').value.trim().replace(/[^\w\-]/g,'_');
  if (!name) return;
  folders.add(name);
  closeModal('newfolder-modal');
  renderFileTree();
  notify(`üìÅ Created folder: ${name}`, 'success');
}

// ============================================================
// FILE TREE
// ============================================================
function renderFileTree() {
  const tree = document.getElementById('file-tree');
  tree.innerHTML = '';
  const allFiles = Object.keys(files).sort();
  const allFolders = new Set([...folders]);
  allFiles.forEach(f => { if (f.includes('/')) allFolders.add(f.split('/')[0]); });
  const rootFiles = allFiles.filter(f => !f.includes('/'));
  const inFolder = {};
  allFiles.filter(f=>f.includes('/')).forEach(f => {
    const fd = f.split('/')[0];
    (inFolder[fd] = inFolder[fd]||[]).push(f);
  });

  if (!allFiles.length && !allFolders.size) {
    tree.innerHTML = '<div style="padding:16px;color:var(--muted);font-size:12px;text-align:center">No files yet<br><br><button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="newFile()">+ New Script</button></div>';
  }

  // Folders
  allFolders.forEach(fd => {
    const isCollapsed = collapsed.has(fd);
    const row = document.createElement('div'); row.className = 'folder-row';
    row.innerHTML = `<span style="font-size:10px">${isCollapsed?'‚ñ∂':'‚ñº'}</span><span>üìÅ</span><span style="flex:1">${fd}</span><div class="fa"><button class="fact-btn" onclick="event.stopPropagation();newFileInFolder('${fd}')" title="New file here">+</button><button class="fact-btn" onclick="event.stopPropagation();deleteFolder('${fd}')" title="Delete folder">üóë</button></div>`;
    row.onclick = () => { collapsed.has(fd)?collapsed.delete(fd):collapsed.add(fd); renderFileTree(); };
    tree.appendChild(row);
    if (!isCollapsed) (inFolder[fd]||[]).forEach(f => tree.appendChild(makeFileEl(f, true)));
  });

  // Root files
  rootFiles.forEach(f => tree.appendChild(makeFileEl(f, false)));

  // Update folder dropdown in new file modal
  const sel = document.getElementById('newfile-folder');
  sel.innerHTML = '<option value="">üìÇ Root (no folder)</option>';
  allFolders.forEach(fd => { const o = document.createElement('option'); o.value=fd; o.textContent=`üìÅ ${fd}`; sel.appendChild(o); });
}

function makeFileEl(name, indented) {
  const el = document.createElement('div');
  el.className = 'file-item'+(name===activeFile?' active':'')+(indented?' indented':'');
  const short = name.includes('/')?name.split('/').slice(1).join('/'):name;
  el.innerHTML = `<span class="file-icon">${name.endsWith('.sk')?'üìú':'üìÑ'}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${name}">${short}</span><div class="factions"><button class="fact-btn safe" onclick="event.stopPropagation();downloadSingleFile('${name}')" title="Download">‚¨á</button><button class="fact-btn safe" onclick="event.stopPropagation();renameFile('${name}')" title="Rename">‚úè</button><button class="fact-btn" onclick="event.stopPropagation();deleteFile('${name}')" title="Delete">üóë</button></div>`;
  el.onclick = () => openFile(name);
  return el;
}

function deleteFolder(fd) {
  const count = Object.keys(files).filter(f=>f.startsWith(fd+'/')).length;
  if (!confirm(`Delete folder "${fd}" and ${count} file(s) inside?`)) return;
  Object.keys(files).filter(f=>f.startsWith(fd+'/')).forEach(f => {
    if (activeFile===f) closeTab(f);
    delete files[f];
    if (roomId) fetch(`/api/rooms/${roomId}/files/${encodeURIComponent(f)}`,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({userName:myName})}).catch(()=>{});
  });
  folders.delete(fd); renderFileTree();
  notify(`üóë Deleted folder: ${fd}`, 'warn');
}

function newFileInFolder(fd) {
  document.getElementById('newfile-folder').value = fd;
  document.getElementById('newfile-name').value = '';
  document.getElementById('newfile-modal').classList.add('open');
  setTimeout(()=>document.getElementById('newfile-name').focus(),100);
}

// ============================================================
// FILE OPS
// ============================================================
function openFile(name) {
  activeFile = name;
  if (!openTabs.includes(name)) openTabs.push(name);
  renderTabs(); renderFileTree();
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('monaco-editor').style.display = 'block';
  if (editor) {
    // FIX: Replaced recreating the model with setValue to preserve stability
    editor.setValue(files[name] || '');
    // Force Monaco to recalculate its size now that the container is visible
    requestAnimationFrame(() => {
      editor.layout();
      editor.focus();
    });
  }
}

function renderTabs() {
  const tabs = document.getElementById('tabs'); tabs.innerHTML = '';
  openTabs.forEach(name => {
    const short = name.includes('/')?name.split('/').pop():name;
    const tab = document.createElement('div'); tab.className='tab'+(name===activeFile?' active':'');
    tab.innerHTML = `<span>üìú</span><span title="${name}">${short}</span><button class="tab-close" onclick="event.stopPropagation();closeTab('${name}')">√ó</button>`;
    tab.onclick = ()=>openFile(name); tabs.appendChild(tab);
  });
}

function closeTab(name) {
  openTabs = openTabs.filter(t=>t!==name);
  if (activeFile===name) {
    if (openTabs.length) openFile(openTabs[openTabs.length-1]);
    else { activeFile=null; document.getElementById('empty-state').style.display='flex'; document.getElementById('monaco-editor').style.display='none'; renderTabs(); renderFileTree(); }
  } else renderTabs();
}

function newFile() {
  renderFileTree();
  document.getElementById('newfile-name').value='';
  document.getElementById('newfile-modal').classList.add('open');
  setTimeout(()=>document.getElementById('newfile-name').focus(),100);
}

function createNewFile() {
  let name = document.getElementById('newfile-name').value.trim();
  if (!name) return;
  if (!name.includes('.')) name += '.sk';
  const fd = document.getElementById('newfile-folder').value;
  const full = fd ? `${fd}/${name}` : name;
  const content = `# ${name}\n# Created in MonkeySkript üêí\n\n`;
  files[full] = content;
  renderFileTree(); closeModal('newfile-modal'); openFile(full);
  notify(`üìú Created ${full}`, 'success');
  termLog(`> Created: ${full}`, 'success');
  saveFileToServer(full, content);
}

function deleteFile(name) {
  if (!confirm(`Delete ${name}?`)) return;
  delete files[name];
  if (activeFile===name) closeTab(name);
  renderFileTree(); notify(`üóë Deleted ${name}`);
  if (roomId) fetch(`/api/rooms/${roomId}/files/${encodeURIComponent(name)}`,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({userName:myName})}).catch(()=>{});
}

function renameFile(oldName) {
  const oldShort = oldName.includes('/')?oldName.split('/').pop():oldName;
  const newShort = prompt('Rename to:', oldShort);
  if (!newShort||newShort===oldShort) return;
  const fd = oldName.includes('/')?oldName.split('/').slice(0,-1).join('/'):'';
  const newName = fd?`${fd}/${newShort}`:newShort;
  files[newName]=files[oldName]; delete files[oldName];
  if (activeFile===oldName) { openTabs=openTabs.map(t=>t===oldName?newName:t); activeFile=newName; }
  renderFileTree(); renderTabs(); notify(`‚úè Renamed to ${newShort}`);
  if (roomId) fetch(`/api/rooms/${roomId}/files/${encodeURIComponent(oldName)}/rename`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({newName,userName:myName})}).catch(()=>{});
}

function validateScript() {
  termLog(`> Validating ${activeFile||'(no file open)'}...`,'warn');
  setTimeout(()=>termLog('> ‚úÖ No syntax errors found!','success'),600);
}

// ============================================================
// UI
// ============================================================
function openShareModal() { if(roomId)showActiveRoom();else showCreateRoom(); document.getElementById('share-modal').classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function switchActivity(act) {
  currentActivity = act;
  document.querySelectorAll('.activity-icon').forEach(i=>i.classList.remove('active'));
  document.getElementById('ab-'+act)?.classList.add('active');
  document.getElementById('sidebar-title').textContent = act==='files'?'EXPLORER':'SEARCH';
  document.getElementById('file-tree-panel').style.display = act==='files'?'block':'none';
  document.getElementById('search-panel').style.display = act==='files'?'none':'flex';
  if (act!=='files') setTimeout(()=>document.getElementById('search-input').focus(),100);
}
function searchFiles() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const res = document.getElementById('search-results'); res.innerHTML='';
  if (!q) return;
  Object.entries(files).forEach(([name,content]) => {
    content.split('\n').forEach((line,i) => {
      if (!line.toLowerCase().includes(q)) return;
      const idx = line.toLowerCase().indexOf(q);
      const d = document.createElement('div'); d.className='search-result';
      d.innerHTML=`<div style="color:var(--accent3);font-size:11px">${name}:${i+1}</div><div>${escHtml(line.slice(0,idx))}<span class="search-match">${escHtml(line.slice(idx,idx+q.length))}</span>${escHtml(line.slice(idx+q.length))}</div>`;
      d.onclick=()=>{openFile(name);setTimeout(()=>editor?.revealLineInCenter(i+1),150);};
      res.appendChild(d);
    });
  });
  if (!res.children.length) res.innerHTML='<div style="color:var(--muted);font-size:12px;padding:8px">No results</div>';
}
function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function togglePanel() { panelVisible=!panelVisible; document.getElementById('bottom-panel').classList.toggle('hidden',!panelVisible); }
function switchPanelTab(el) { document.querySelectorAll('.panel-tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); }
function termLog(msg,type='') {
  const t=document.getElementById('terminal');
  const d=document.createElement('div'); d.className='terminal-line '+type; d.textContent=msg;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
  if (!panelVisible) togglePanel();
}
function notify(msg,type='') {
  const n=document.createElement('div'); n.className='notif '+type; n.textContent=msg;
  document.getElementById('notifications').appendChild(n);
  setTimeout(()=>n.remove(),3500);
}

// ============================================================
// COMMAND PALETTE
// ============================================================
const COMMANDS = [
  {label:'New File',desc:'Create a new .sk script',key:'Ctrl+N',action:newFile},
  {label:'New Folder',desc:'Create a folder',action:newFolder},
  {label:'Download Current File',desc:'Save active file to disk',action:downloadActiveFile},
  {label:'Download All as ZIP',desc:'Download everything',action:downloadAllFiles},
  {label:'Save All',desc:'Save all files to room',key:'Ctrl+S',action:saveAll},
  {label:'Skript Snippets',desc:'Insert common patterns',action:showSkriptSnippets},
  {label:'Toggle Terminal',desc:'Show/hide terminal panel',key:'Ctrl+`',action:togglePanel},
  {label:'Live Share ‚Üí Create Room',desc:'Start multiplayer session',action:()=>{showCreateRoom();openShareModal();}},
  {label:'Live Share ‚Üí Join Room',desc:'Join an existing room',action:()=>{showJoinRoom();openShareModal();}},
  {label:'Format Document',desc:'Auto-format current file',action:()=>{editor?.getAction('editor.action.formatDocument')?.run();notify('‚ú® Formatted!','success');}},
  {label:'Search in Files',desc:'Find text across all scripts',action:()=>switchActivity('search')},
  {label:'Settings',desc:'Open settings panel',action:openSettings},
  {label:'Copy Room Code',desc:'Copy collaboration code',action:()=>roomId?copyRoomCode():notify('Not in a room!','warn')},
  {label:'Validate Script',desc:'Check current file for errors',action:validateScript},
  {label:'Delete Current File',desc:'Delete the active file',action:()=>activeFile&&deleteFile(activeFile)},
];
let cmdSelected=0;
document.addEventListener('keydown', e=>{
  if ((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key==='P'){e.preventDefault();openCommandPalette();}
  if ((e.ctrlKey||e.metaKey)&&e.key==='n'){e.preventDefault();newFile();}
  if ((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();saveAll();}
  if ((e.ctrlKey||e.metaKey)&&e.key==='`'){e.preventDefault();togglePanel();}
  if (e.key==='Escape'){document.getElementById('command-palette').classList.remove('open');['share-modal','newfile-modal','newfolder-modal','snippets-modal','settings-modal'].forEach(closeModal);}
});
function openCommandPalette(){document.getElementById('command-palette').classList.add('open');document.getElementById('cmd-input').value='';filterCmds();document.getElementById('cmd-input').focus();}
function filterCmds(){
  const q=document.getElementById('cmd-input').value.toLowerCase();
  const filtered=COMMANDS.filter(c=>c.label.toLowerCase().includes(q)||c.desc.toLowerCase().includes(q));
  cmdSelected=0;
  const res=document.getElementById('cmd-results');res.innerHTML='';
  filtered.forEach((c,i)=>{
    const d=document.createElement('div');d.className='cmd-result'+(i===0?' selected':'');
    d.innerHTML=`<span>${c.label} <span style="color:var(--muted);font-size:11px">${c.desc}</span></span><span class="cmd-key">${c.key||''}</span>`;
    d.onclick=()=>{c.action();document.getElementById('command-palette').classList.remove('open');};
    res.appendChild(d);
  });
}
function cmdKeydown(e){
  const items=document.querySelectorAll('.cmd-result');
  if(e.key==='ArrowDown')cmdSelected=Math.min(cmdSelected+1,items.length-1);
  else if(e.key==='ArrowUp')cmdSelected=Math.max(cmdSelected-1,0);
  else if(e.key==='Enter'){items[cmdSelected]?.click();return;}
  items.forEach((el,i)=>el.classList.toggle('selected',i===cmdSelected));
}

// ============================================================
// SNIPPETS
// ============================================================
const SNIPPETS=[
  {name:'üëã Player Join',code:'on join:\n    send "&aWelcome, &e%player%&a!" to player\n    give player 1 diamond'},
  {name:'üíÄ Player Death',code:'on death of player:\n    broadcast "&cüíÄ %player% died!"\n    add 1 to {deaths.%player%}'},
  {name:'‚öîÔ∏è Custom Command',code:'command /heal:\n    permission: admin.heal\n    trigger:\n        heal player\n        send "&aHealed!" to player'},
  {name:'üí∞ Economy Balance',code:'command /balance:\n    trigger:\n        set {_bal} to {balance.%player%} ? 0\n        send "&aBalance: &6$%{_bal}%" to player'},
  {name:'üèÜ Kill Tracker',code:'on death of player:\n    if attacker is a player:\n        add 1 to {kills.%attacker%}\n        send "&a+1 Kill!" to attacker'},
  {name:'üì¢ Broadcast Timer',code:'every 10 minutes:\n    broadcast "&6[Server] &fVote at vote.example.com!"'},
  {name:'üéÆ Gamemode Command',code:'command /gm <text>:\n    permission: op\n    trigger:\n        if arg 1 is "c":\n            set gamemode of player to creative\n        else:\n            set gamemode of player to survival'},
  {name:'üõ°Ô∏è Anti-Spam Chat',code:'on chat:\n    if {spam.%player%} is set:\n        cancel event\n        send "&cSlow down!" to player\n        stop\n    set {spam.%player%} to true\n    wait 3 seconds\n    delete {spam.%player%}'},
  {name:'üåç Loop All Players',code:'every 30 seconds:\n    loop all players:\n        send "&7[Tip] &fUse /help for commands!" to loop-player'},
  {name:'üì¶ Item Shop',code:'command /buy <text>:\n    trigger:\n        if arg 1 is "sword":\n            if {balance.%player%} >= 100:\n                remove 100 from {balance.%player%}\n                give player 1 diamond sword\n                send "&aBought!" to player\n            else:\n                send "&cNeed $100!" to player'},
];
function showSkriptSnippets(){
  const list=document.getElementById('snippet-list');list.innerHTML='';
  SNIPPETS.forEach(s=>{
    const d=document.createElement('div');d.className='snippet-card';
    d.innerHTML=`<div class="snippet-title">${s.name}</div><pre class="snippet-preview">${s.code.slice(0,120)}${s.code.length>120?'...':''}</pre>`;
    d.onclick=()=>{
      if(editor&&activeFile){
        const pos=editor.getPosition();
        editor.executeEdits('snippet',[{range:new monaco.Range(pos.lineNumber,1,pos.lineNumber,1),text:s.code+'\n\n'}]);
        closeModal('snippets-modal');notify(`üß© Inserted: ${s.name}`,'success');
      } else notify('Open a file first!','warn');
    };
    list.appendChild(d);
  });
  document.getElementById('snippets-modal').classList.add('open');
}

// ============================================================
// RESIZE
// ============================================================
let resizing=false;
function startResize(e){
  resizing=true;e.preventDefault();
  document.onmousemove=ev=>{
    if(!resizing)return;
    const h=document.getElementById('app').getBoundingClientRect().bottom-ev.clientY;
    if(h>60&&h<500)document.getElementById('bottom-panel').style.height=h+'px';
  };
  document.onmouseup=()=>{resizing=false;document.onmousemove=null;};
}

setTimeout(()=>notify('‚ö° Ctrl+Shift+P for all commands','success'),2000);
</script>
</body>
</html>
