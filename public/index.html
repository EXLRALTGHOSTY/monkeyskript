<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÊéßÂà∂ üêí MonkeySkript</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<style>
  :root {
    --bg: #0a0a0f; --sidebar: #0f0f1a; --panel: #13131f; --border: #1e1e3a;
    --accent: #00ff9d; --accent2: #ff6b35; --accent3: #7c3aed;
    --text: #e2e8f0; --muted: #4a5568; --tab-active: #1a1a2e; --tab-bg: #0f0f1a;
    --danger: #ef4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
  #titlebar { height: 38px; background: #06060f; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 12px; gap: 12px; flex-shrink: 0; z-index: 100; }
  .logo { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 14px; background: linear-gradient(90deg, var(--accent), #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 2px; display: flex; align-items: center; gap: 6px; }
  .logo-icon { font-size: 18px; filter: drop-shadow(0 0 8px var(--accent)); }
  .menu-bar { display: flex; gap: 2px; margin-left: 8px; }
  .menu-item { padding: 4px 10px; font-size: 12px; color: var(--muted); cursor: pointer; border-radius: 4px; font-family: 'JetBrains Mono', monospace; position: relative; }
  .menu-item:hover { background: var(--border); color: var(--text); }
  .dropdown { display: none; position: absolute; top: 100%; left: 0; background: var(--panel); border: 1px solid var(--border); border-radius: 6px; min-width: 200px; z-index: 500; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
  .menu-item:hover .dropdown { display: block; }
  .dd-item { padding: 8px 14px; font-size: 12px; color: var(--text); cursor: pointer; display: flex; justify-content: space-between; align-items: center; gap: 16px; white-space: nowrap; }
  .dd-item:hover { background: rgba(0,255,157,0.08); color: var(--accent); }
  .dd-key { color: var(--muted); font-size: 11px; }
  .dd-sep { height: 1px; background: var(--border); margin: 4px 0; }
  .collab-bar { margin-left: auto; display: flex; align-items: center; gap: 10px; }
  .room-info { display: flex; align-items: center; gap: 8px; background: var(--panel); border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px; font-size: 11px; }
  .pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(0,255,157,0.4)} 50%{box-shadow:0 0 0 6px rgba(0,255,157,0)} }
  .user-avatars { display: flex; gap: 4px; }
  .avatar { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; border: 2px solid var(--bg); cursor: pointer; transition: transform 0.2s; }
  .avatar:hover { transform: scale(1.2); }
  .share-btn { background: linear-gradient(135deg, var(--accent3), #a855f7); border: none; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; cursor: pointer; font-family: 'JetBrains Mono', monospace; transition: all 0.2s; }
  .share-btn:hover { transform: scale(1.05); box-shadow: 0 0 12px rgba(124,58,237,0.5); }
  #app { display: flex; flex: 1; overflow: hidden; }
  #activitybar { width: 48px; background: #06060f; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 8px 0; gap: 4px; flex-shrink: 0; }
  .activity-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; border-radius: 6px; color: var(--muted); transition: all 0.2s; position: relative; }
  .activity-icon:hover { color: var(--text); background: var(--border); }
  .activity-icon.active { color: var(--accent); }
  .activity-icon.active::before { content: ''; position: absolute; left: -8px; top: 50%; transform: translateY(-50%); width: 2px; height: 20px; background: var(--accent); border-radius: 0 2px 2px 0; }
  #sidebar { width: 240px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; }
  .sidebar-header { padding: 10px 14px; font-size: 10px; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .sidebar-action { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 14px; padding: 2px 4px; border-radius: 3px; transition: all 0.15s; }
  .sidebar-action:hover { color: var(--accent); background: var(--border); }
  #file-tree { flex: 1; overflow-y: auto; padding: 4px 0; }
  .file-item { display: flex; align-items: center; gap: 8px; padding: 5px 14px; font-size: 13px; cursor: pointer; border-radius: 4px; margin: 1px 6px; color: var(--text); }
  .file-item:hover { background: var(--border); }
  .file-item.active { background: rgba(0,255,157,0.08); color: var(--accent); }
  #editor-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  #tabs { height: 35px; background: var(--tab-bg); border-bottom: 1px solid var(--border); display: flex; overflow-x: auto; flex-shrink: 0; }
  .tab { display: flex; align-items: center; gap: 8px; padding: 0 14px; height: 100%; cursor: pointer; border-right: 1px solid var(--border); white-space: nowrap; font-size: 12px; color: var(--muted); }
  .tab.active { background: var(--tab-active); color: var(--text); border-bottom: 2px solid var(--accent); }
  .tab-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 14px; width: 18px; height: 18px; border-radius: 3px; }
  #editor-container { flex: 1; position: relative; overflow: hidden; }
  #monaco-editor { width: 100%; height: 100%; }
  .empty-state { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; color: var(--muted); }
  .empty-logo { font-size: 64px; animation: float 3s ease-in-out infinite; }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
  .empty-title { font-family: 'Orbitron', sans-serif; font-size: 28px; font-weight: 900; background: linear-gradient(90deg, var(--accent), #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 4px; }
  .start-btn { padding: 10px 20px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 12px; cursor: pointer; border: none; margin: 5px; }
  .start-btn.primary { background: linear-gradient(135deg, var(--accent), #00d4ff); color: #000; font-weight: 700; }
  #statusbar { height: 24px; background: var(--accent3); display: flex; align-items: center; padding: 0 12px; gap: 16px; font-size: 11px; flex-shrink: 0; color: white; }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; width: 480px; padding: 24px; }
  .modal-input { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 8px; margin-bottom: 12px; }
  .btn { padding: 8px 18px; border-radius: 8px; cursor: pointer; border: none; }
  .btn-primary { background: var(--accent); color: #000; font-weight: 700; }
  .btn-secondary { background: var(--bg); color: var(--muted); border: 1px solid var(--border); }
  #notifications { position: fixed; top: 50px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
  .notif { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px 16px; font-size: 12px; border-left: 3px solid var(--accent); animation: slideIn 0.3s ease; }
  @keyframes slideIn { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }
  .snippet-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; cursor: pointer; margin-bottom: 8px; }
  .snippet-card:hover { border-color: var(--accent); }
</style>
</head>
<body>

<div id="titlebar">
  <div class="logo"><span class="logo-icon">üêí</span>MONKEYSKRIPT</div>
  <div class="menu-bar">
    <div class="menu-item">File
      <div class="dropdown">
        <div class="dd-item" onclick="newFile()">New Script</div>
        <div class="dd-item" onclick="saveActiveFile()">Save <span class="dd-key">Ctrl+S</span></div>
      </div>
    </div>
    <div class="menu-item">Run
      <div class="dropdown">
        <div class="dd-item" onclick="showSkriptSnippets()">Insert Snippet üß©</div>
      </div>
    </div>
  </div>
  <div class="collab-bar">
    <div class="room-info" id="room-display" style="display:none">
      <div class="pulse"></div>
      <span id="room-label">Room: --</span>
      <div class="user-avatars" id="avatar-list"></div>
    </div>
    <button class="share-btn" onclick="openShareModal()">‚ö° Live Share</button>
  </div>
</div>

<div id="notifications"></div>

<div id="app">
  <div id="activitybar">
    <div class="activity-icon active">üìÅ</div>
    <div class="activity-icon" onclick="showSkriptSnippets()">üß©</div>
    <div style="margin-top:auto"></div>
    <div class="activity-icon">‚öôÔ∏è</div>
  </div>

  <div id="sidebar">
    <div class="sidebar-header">
      <span>EXPLORER</span>
      <button class="sidebar-action" onclick="newFile()">üìÑ</button>
    </div>
    <div id="file-tree"></div>
  </div>

  <div id="editor-area">
    <div id="tabs"></div>
    <div id="editor-container">
      <div class="empty-state" id="empty-state">
        <div class="empty-logo">üêí</div>
        <div class="empty-title">MONKEYSKRIPT</div>
        <div class="start-actions">
          <button class="start-btn primary" onclick="newFile()">+ New Script</button>
          <button class="start-btn" onclick="openShareModal()">‚ö° Join Room</button>
        </div>
      </div>
      <div id="monaco-editor" style="display:none"></div>
    </div>
  </div>
</div>

<div id="statusbar">
  <div class="status-item"><span id="conn-status">Offline</span></div>
  <div class="status-right" style="margin-left:auto">
    <div class="status-item"><span id="sb-pos">Ln 1, Col 1</span></div>
    <div class="status-item">Skript</div>
  </div>
</div>

<div class="modal-overlay" id="share-modal" onclick="if(event.target===this)closeModal('share-modal')">
  <div class="modal">
    <h2>‚ö° LIVE SHARE</h2>
    <div id="share-create">
      <input class="modal-input" id="room-name-input" placeholder="Display Name">
      <button class="btn btn-primary" onclick="createRoom()">üöÄ Create Room</button>
      <button class="btn btn-secondary" onclick="showJoinRoom()">Join Existing</button>
    </div>
    <div id="share-active" style="display:none">
      <p>Share code: <strong id="active-room-code" style="color:var(--accent)"></strong></p>
      <div id="active-collab-users"></div>
      <button class="btn btn-secondary" onclick="location.reload()">üö™ Leave</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="newfile-modal" onclick="if(event.target===this)closeModal('newfile-modal')">
  <div class="modal">
    <h2>üìú NEW SCRIPT</h2>
    <input class="modal-input" id="newfile-name" placeholder="filename.sk">
    <button class="btn btn-primary" onclick="createNewFile()">Create</button>
    <button class="btn btn-secondary" onclick="closeModal('newfile-modal')">Cancel</button>
  </div>
</div>

<div class="modal-overlay" id="snippets-modal" onclick="if(event.target===this)closeModal('snippets-modal')">
  <div class="modal" style="max-height:80vh; overflow-y:auto">
    <h2>üß© SNIPPETS</h2>
    <div id="snippet-list"></div>
    <button class="btn btn-secondary" onclick="closeModal('snippets-modal')">Close</button>
  </div>
</div>

<script>
// ============================================================
// CORE STATE
// ============================================================
let editor = null;
let files = {};          
let activeFile = null;
let openTabs = [];
let roomId = null;
let lastSyncTime = 0;
let myName = 'Monkey' + Math.floor(Math.random()*99);
let myColor = '#' + Math.floor(Math.random()*16777215).toString(16);

// ============================================================
// MONACO INITIALIZATION
// ============================================================
require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
require(['vs/editor/editor.main'], function() {
    // Custom Skript Language
    monaco.languages.register({ id: 'skript' });
    monaco.languages.setMonarchTokensProvider('skript', {
        tokenizer: {
            root: [
                [/on (join|quit|chat|death|break|place):/, 'keyword'],
                [/if|else|loop|while|wait|stop|send|broadcast|set|add|remove|delete/, 'keyword'],
                [/".*?"/, 'string'],
                [/\{.*?\}/, 'variable'],
                [/%(.*?)%/, 'variable.parameter'],
                [/#[^]*$/, 'comment'],
            ]
        }
    });

    editor = monaco.editor.create(document.getElementById('monaco-editor'), {
        value: '',
        language: 'skript',
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 14
    });

    editor.onDidChangeCursorPosition(e => {
        document.getElementById('sb-pos').innerText = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
    });

    // Save on type (with a small debounce)
    let timeout;
    editor.onDidChangeModelContent(() => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            if(activeFile) saveActiveFile();
        }, 800);
    });
});

// ============================================================
// FILE & SERVER LOGIC
// ============================================================

async function openFile(path) {
    activeFile = path;
    
    // UI Fix: Switch from Monkey main page to Editor
    document.getElementById('empty-state').style.display = 'none';
    document.getElementById('monaco-editor').style.display = 'block';

    if (files[path] !== undefined) {
        editor.setValue(files[path]);
    } else {
        editor.setValue(""); 
    }

    if (!openTabs.includes(path)) openTabs.push(path);
    renderTabs();
    renderFileTree();
}

async function saveActiveFile() {
    if (!activeFile || !roomId) return;
    const content = editor.getValue();
    files[activeFile] = content;
    
    await fetch(`/api/rooms/${roomId}/files`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: activeFile, content })
    });
}

async function createRoom() {
    const res = await fetch('/api/rooms', { method: 'POST' });
    const data = await res.json();
    roomId = data.roomId;
    
    document.getElementById('share-create').style.display = 'none';
    document.getElementById('share-active').style.display = 'block';
    document.getElementById('active-room-code').innerText = roomId;
    document.getElementById('room-display').style.display = 'flex';
    document.getElementById('room-label').innerText = `Room: ${roomId}`;
    
    startPolling();
    notify("Room Created!", "success");
}

function startPolling() {
    setInterval(async () => {
        if (!roomId) return;
        
        // Presence
        await fetch(`/api/rooms/${roomId}/presence`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userName: myName, userColor: myColor, editingFile: activeFile })
        });

        // Sync Content
        const res = await fetch(`/api/rooms/${roomId}/poll?since=${lastSyncTime}`);
        const data = await res.json();
        lastSyncTime = data.serverTime;

        data.changedFiles.forEach(f => {
            files[f.filename] = f.content;
            if (activeFile === f.filename && editor.getValue() !== f.content) {
                const pos = editor.getPosition();
                editor.setValue(f.content);
                editor.setPosition(pos);
            }
        });

        // Update User List
        const avatarList = document.getElementById('avatar-list');
        avatarList.innerHTML = '';
        data.users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'avatar';
            div.style.background = u.user_color;
            div.innerText = u.user_name[0].toUpperCase();
            div.title = u.user_name;
            avatarList.appendChild(div);
        });
    }, 2000);
}

// ============================================================
// UI HELPERS
// ============================================================

function renderFileTree() {
    const tree = document.getElementById('file-tree');
    tree.innerHTML = '';
    Object.keys(files).forEach(f => {
        const div = document.createElement('div');
        div.className = `file-item ${activeFile === f ? 'active' : ''}`;
        div.innerHTML = `üìÑ ${f}`;
        div.onclick = () => openFile(f);
        tree.appendChild(div);
    });
}

function renderTabs() {
    const tabs = document.getElementById('tabs');
    tabs.innerHTML = '';
    openTabs.forEach(t => {
        const div = document.createElement('div');
        div.className = `tab ${activeFile === t ? 'active' : ''}`;
        div.innerHTML = `${t} <span class="tab-close" onclick="closeTab(event,'${t}')">√ó</span>`;
        div.onclick = () => openFile(t);
        tabs.appendChild(div);
    });
}

function closeTab(e, path) {
    e.stopPropagation();
    openTabs = openTabs.filter(t => t !== path);
    if (activeFile === path) {
        activeFile = openTabs[0] || null;
        if (activeFile) openFile(activeFile);
        else {
            document.getElementById('empty-state').style.display = 'flex';
            document.getElementById('monaco-editor').style.display = 'none';
        }
    }
    renderTabs();
}

function newFile() { document.getElementById('newfile-modal').classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function createNewFile() {
    const name = document.getElementById('newfile-name').value;
    if (!name) return;
    files[name] = "# New Skript\n";
    closeModal('newfile-modal');
    openFile(name);
}

function notify(msg, type) {
    const n = document.getElementById('notifications');
    const div = document.createElement('div');
    div.className = `notif ${type}`;
    div.innerText = msg;
    n.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

// Snippet Logic
const SNIPPETS = [
    { name: "Join Message", code: 'on join:\n    broadcast "&a%player% has arrived!"' },
    { name: "Simple Command", code: 'command /hello:\n    trigger:\n        send "Hi there!"' }
];

function showSkriptSnippets() {
    const list = document.getElementById('snippet-list');
    list.innerHTML = '';
    SNIPPETS.forEach(s => {
        const d = document.createElement('div');
        d.className = 'snippet-card';
        d.innerHTML = `<strong>${s.name}</strong><pre>${s.code}</pre>`;
        d.onclick = () => {
            if (!activeFile) return notify("Open a file first!", "warn");
            const pos = editor.getPosition();
            editor.executeEdits('snippet', [{ range: new monaco.Range(pos.lineNumber, 1, pos.lineNumber, 1), text: s.code + '\n' }]);
            closeModal('snippets-modal');
        };
        list.appendChild(d);
    });
    document.getElementById('snippets-modal').classList.add('open');
}

function openShareModal() { document.getElementById('share-modal').classList.add('open'); }
function showJoinRoom() { /* logic to show join input */ }

</script>
</body>
</html>
